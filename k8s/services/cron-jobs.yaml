# ──────────────────────────────────────────────────────────────
# K8s CronJobs for MonkeysWork scheduled tasks.
#
# All jobs call the API's /api/v1/cron/* endpoints using curl
# authenticated with X-Internal-Token.
#
# These persist across deploys as standalone CronJob resources
# in the monkeyswork namespace.
# ──────────────────────────────────────────────────────────────

# ── Daily 8:00 AM UTC: Job recommendations for freelancers ───
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cron-recommend-jobs
  namespace: monkeyswork
  labels:
    app: monkeyswork-cron
    task: recommend-jobs
spec:
  schedule: "0 8 * * *"           # Daily at 08:00 UTC
  timeZone: "Etc/UTC"
  concurrencyPolicy: Forbid       # Don't overlap runs
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 5
  startingDeadlineSeconds: 300    # Allow 5 min late start
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600  # Max 10 min
      template:
        metadata:
          labels:
            app: monkeyswork-cron
            task: recommend-jobs
        spec:
          restartPolicy: OnFailure
          containers:
            - name: cron-runner
              image: curlimages/curl:8.5.0
              command:
                - /bin/sh
                - -c
                - |
                  echo "[$(date -u)] Starting daily job recommendations..."
                  HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
                    -X POST \
                    -H "X-Internal-Token: ${INTERNAL_API_TOKEN}" \
                    -H "Content-Type: application/json" \
                    "http://monkeyswork-api.monkeyswork.svc.cluster.local/api/v1/cron/recommend-jobs")
                  echo "HTTP ${HTTP_CODE}:"
                  cat /tmp/response.txt
                  echo ""
                  if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                    echo "[$(date -u)] Done ✓"
                    exit 0
                  else
                    echo "[$(date -u)] FAILED ✗"
                    exit 1
                  fi
              env:
                - name: INTERNAL_API_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: internal-api-token
                      key: token
              resources:
                requests:
                  cpu: 50m
                  memory: 32Mi
                limits:
                  cpu: 100m
                  memory: 64Mi
---
# ── Monday 06:00 AM UTC: Charge clients for hourly timesheets ─
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cron-charge-weekly
  namespace: monkeyswork
  labels:
    app: monkeyswork-cron
    task: charge-weekly
spec:
  schedule: "0 6 * * 1"           # Monday at 06:00 UTC
  timeZone: "Etc/UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 5
  startingDeadlineSeconds: 300
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600
      template:
        metadata:
          labels:
            app: monkeyswork-cron
            task: charge-weekly
        spec:
          restartPolicy: OnFailure
          containers:
            - name: cron-runner
              image: curlimages/curl:8.5.0
              command:
                - /bin/sh
                - -c
                - |
                  echo "[$(date -u)] Starting weekly client charges..."
                  HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
                    -X POST \
                    -H "X-Internal-Token: ${INTERNAL_API_TOKEN}" \
                    -H "Content-Type: application/json" \
                    "http://monkeyswork-api.monkeyswork.svc.cluster.local/api/v1/cron/charge-weekly")
                  echo "HTTP ${HTTP_CODE}:"
                  cat /tmp/response.txt
                  echo ""
                  if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                    echo "[$(date -u)] Done ✓"
                    exit 0
                  else
                    echo "[$(date -u)] FAILED ✗"
                    exit 1
                  fi
              env:
                - name: INTERNAL_API_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: internal-api-token
                      key: token
              resources:
                requests:
                  cpu: 50m
                  memory: 32Mi
                limits:
                  cpu: 100m
                  memory: 64Mi
---
# ── Friday 06:00 AM UTC: Pay freelancers ──────────────────────
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cron-payout-weekly
  namespace: monkeyswork
  labels:
    app: monkeyswork-cron
    task: payout-weekly
spec:
  schedule: "0 6 * * 5"           # Friday at 06:00 UTC
  timeZone: "Etc/UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 5
  startingDeadlineSeconds: 300
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600
      template:
        metadata:
          labels:
            app: monkeyswork-cron
            task: payout-weekly
        spec:
          restartPolicy: OnFailure
          containers:
            - name: cron-runner
              image: curlimages/curl:8.5.0
              command:
                - /bin/sh
                - -c
                - |
                  echo "[$(date -u)] Starting weekly freelancer payouts..."
                  HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
                    -X POST \
                    -H "X-Internal-Token: ${INTERNAL_API_TOKEN}" \
                    -H "Content-Type: application/json" \
                    "http://monkeyswork-api.monkeyswork.svc.cluster.local/api/v1/cron/payout-weekly")
                  echo "HTTP ${HTTP_CODE}:"
                  cat /tmp/response.txt
                  echo ""
                  if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                    echo "[$(date -u)] Done ✓"
                    exit 0
                  else
                    echo "[$(date -u)] FAILED ✗"
                    exit 1
                  fi
              env:
                - name: INTERNAL_API_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: internal-api-token
                      key: token
              resources:
                requests:
                  cpu: 50m
                  memory: 32Mi
                limits:
                  cpu: 100m
                  memory: 64Mi
---
# ── Daily 07:00 AM UTC: Check dispute deadlines ──────────────
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cron-check-deadlines
  namespace: monkeyswork
  labels:
    app: monkeyswork-cron
    task: check-deadlines
spec:
  schedule: "0 7 * * *"           # Daily at 07:00 UTC
  timeZone: "Etc/UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 5
  startingDeadlineSeconds: 300
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 300  # Max 5 min (lighter task)
      template:
        metadata:
          labels:
            app: monkeyswork-cron
            task: check-deadlines
        spec:
          restartPolicy: OnFailure
          containers:
            - name: cron-runner
              image: curlimages/curl:8.5.0
              command:
                - /bin/sh
                - -c
                - |
                  echo "[$(date -u)] Checking dispute deadlines..."
                  HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
                    -X POST \
                    -H "X-Internal-Token: ${INTERNAL_API_TOKEN}" \
                    -H "Content-Type: application/json" \
                    "http://monkeyswork-api.monkeyswork.svc.cluster.local/api/v1/cron/check-deadlines")
                  echo "HTTP ${HTTP_CODE}:"
                  cat /tmp/response.txt
                  echo ""
                  if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                    echo "[$(date -u)] Done ✓"
                    exit 0
                  else
                    echo "[$(date -u)] FAILED ✗"
                    exit 1
                  fi
              env:
                - name: INTERNAL_API_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: internal-api-token
                      key: token
              resources:
                requests:
                  cpu: 50m
                  memory: 32Mi
                limits:
                  cpu: 100m
                  memory: 64Mi
---
# ── Daily 10:00 AM UTC: Retry failed payment charges ─────────
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cron-retry-charges
  namespace: monkeyswork
  labels:
    app: monkeyswork-cron
    task: retry-charges
spec:
  schedule: "0 10 * * *"          # Daily at 10:00 UTC
  timeZone: "Etc/UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 5
  startingDeadlineSeconds: 300
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600  # Max 10 min
      template:
        metadata:
          labels:
            app: monkeyswork-cron
            task: retry-charges
        spec:
          restartPolicy: OnFailure
          containers:
            - name: cron-runner
              image: curlimages/curl:8.5.0
              command:
                - /bin/sh
                - -c
                - |
                  echo "[$(date -u)] Retrying failed payment charges..."
                  HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
                    -X POST \
                    -H "X-Internal-Token: ${INTERNAL_API_TOKEN}" \
                    -H "Content-Type: application/json" \
                    "http://monkeyswork-api.monkeyswork.svc.cluster.local/api/v1/cron/retry-failed-charges")
                  echo "HTTP ${HTTP_CODE}:"
                  cat /tmp/response.txt
                  echo ""
                  if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                    echo "[$(date -u)] Done ✓"
                    exit 0
                  else
                    echo "[$(date -u)] FAILED ✗"
                    exit 1
                  fi
              env:
                - name: INTERNAL_API_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: internal-api-token
                      key: token
              resources:
                requests:
                  cpu: 50m
                  memory: 32Mi
                limits:
                  cpu: 100m
                  memory: 64Mi
